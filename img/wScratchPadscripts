(function(n){function i(n,t){return this.sp=null,this.settings=n,this.$elem=t,this.enabled=!0,this.scratch=!1,this.canvas=null,this.ctx=null,this}var t=0,r="";n.fn.wScratchPad=function(t,r){if(typeof t=="object")r=t;else if(typeof t=="string"){var u=[],f=this.each(function(){var i=n(this).data("_wScratchPad");i&&(t==="reset"?i.reset():t==="clear"?i.clear():t==="enabled"?i.enabled=r===!0:n.fn.wScratchPad.defaultSettings[t]!==undefined&&(r!==undefined?i.settings[t]=r:u.push(i.settings[t])))});return u.length===1?u[0]:u.length>0?u:f}return r=n.extend({},n.fn.wScratchPad.defaultSettings,r||{}),this.each(function(){var u=n(this),f=jQuery.extend(!0,{},r),e=document.createElement("canvas"),t;if(!e.getContext)return u.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser."),!1;t=new i(f,u),u.append(t.generate()),t.pixels=t.canvas.width*t.canvas.height,u.data("_wScratchPad",t),t.init()})},n.fn.wScratchPad.defaultSettings={width:549,height:170,image:"/images/ob/center/failure.jpg",image2:"/images/ob/center/scratch.jpg",color:null,overlay:"none",size:30,scratchDown:null,scratchUp:null,scratchMove:null,cursor:null},i.prototype={generate:function(){var t=this;return this.canvas=document.createElement("canvas"),this.canvas.id="canvas",this.ctx=this.canvas.getContext("2d"),this.sp=n("<div></div>").css({position:"relative"}).append(n(this.canvas).attr("width",this.settings.width+"px").attr("height",this.settings.height+"px")),n(this.canvas).mousedown(function(i){if(!t.enabled)return!0;i.preventDefault(),i.stopPropagation(),t.canvas_offset=n(t.canvas).offset(),t.scratch=!0,t.scratchFunc(i,t,"Down")}).mousemove(function(n){n.preventDefault(),n.stopPropagation(),t.scratch&&t.scratchFunc(n,t,"Move")}).mouseup(function(n){n.preventDefault(),n.stopPropagation(),t.scratch&&(t.scratch=!1,t.scratchFunc(n,t,"Up"))}),this.bindMobile(this.sp),this.sp},bindMobile:function(n){n.bind("touchstart touchmove touchend touchcancel",function(){var r=event.changedTouches,n=r[0],t="",i;switch(event.type){case"touchstart":t="mousedown";break;case"touchmove":t="mousemove";break;case"touchend":t="mouseup";break;default:return}i=document.createEvent("MouseEvent"),i.initMouseEvent(t,!0,!0,window,1,n.screenX,n.screenY,n.clientX,n.clientY,!1,!1,!1,!1,0,null),n.target.dispatchEvent(i),event.preventDefault()})},init:function(){t=0,this.sp.css("width",this.settings.width),this.sp.css("height",this.settings.height),this.sp.css("cursor",this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"),n(this.canvas).css({cursor:this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"}),this.canvas.width=this.settings.width,this.canvas.height=this.settings.height,this.pixels=this.canvas.width*this.canvas.height,this.settings.image2?this.drawImage(this.settings.image2):(this.settings.overlay!="none"?(this.settings.image&&this.drawImage(this.settings.image),this.ctx.globalCompositeOperation=this.settings.overlay):this.setBgImage(),this.ctx.fillStyle=this.settings.color,this.ctx.beginPath(),this.ctx.rect(0,0,this.settings.width,this.settings.height),this.ctx.fill())},reset:function(){this.ctx.globalCompositeOperation="source-over",this.init()},clear:function(){this.ctx.clearRect(0,0,this.settings.width,this.settings.height)},setBgImage:function(){this.settings.image&&this.sp.css({backgroundImage:"url("+this.settings.image+")"})},drawImage:function(t){var r=this,i=new Image;i.src=t,n(i).load(function(){r.ctx.drawImage(i,0,0),r.setBgImage()})},scratchFunc:function(n,t,i){n.pageX=Math.floor(n.pageX-t.canvas_offset.left),n.pageY=Math.floor(n.pageY-t.canvas_offset.top),t["scratch"+i](n,t),t.settings["scratch"+i]&&t.settings["scratch"+i].apply(t,[n,t.scratchPercentage(t)])},scratchPercentage:function(n){for(var u=0,i=n.ctx.getImageData(0,0,n.canvas.width,n.canvas.height),t=0,r=i.data.length;t<r;t=t+4)i.data[t]==0&&i.data[t+1]==0&&i.data[t+2]==0&&i.data[t+3]==0&&u++;return u/n.pixels*100},scratchDown:function(i,r){r.ctx.globalCompositeOperation="destination-out",r.ctx.lineJoin="round",r.ctx.lineCap="round",r.ctx.strokeStyle=r.settings.color,r.ctx.lineWidth=r.settings.size,r.ctx.beginPath(),r.ctx.arc(i.pageX,i.pageY,r.settings.size/2,0,Math.PI*2,!0),r.ctx.closePath(),r.ctx.fill(),r.ctx.beginPath(),r.ctx.moveTo(i.pageX,i.pageY),t==0&&(t+=1,n.ajax({url:"/Utility/LorealHanlder.ashx",type:"post",dataType:"json",cache:!1,async:!1,data:{action:"LOTTERY"},success:function(t){t.ID==1?(t.Winner==-1||t.Winner==1,n("#txtTimes").text(t.Times)):alert(t.DES)},error:function(){alert("系统繁忙，请稍后再试!")}}))},scratchMove:function(t,i){var f,u,e;for(i.crossOrigin="anonymous",i.ctx.lineTo(t.pageX,t.pageY),i.ctx.stroke(),f=i.ctx.getImageData(110,15,120,330).data,u=0,e=0;u<f.length;u+=4)f[u+3]!=0&&e++;e<=f.length/4*.3&&(n("#canvas").fadeOut(1e3),n(".lottery .tip").hide(),n(".lottery .again").show(),r!=""&&countDown(3,r,"spanCount"))},scratchUp:function(n,t){t.ctx.closePath()}}})(jQuery)